<Page x:Class="DataVisualizationPlatform.Views.Data"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:vm="clr-namespace:DataVisualizationPlatform.ViewModels"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      mc:Ignorable="d"
      d:DesignHeight="450" d:DesignWidth="800">

    <Page.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/Resources/Styles/DataStyle.xaml"/>
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </Page.Resources>

    <!--<Page.DataContext>
        <vm:DataViewModel />
    </Page.DataContext>-->

    <Grid Background="Transparent" Margin="20">
        <!-- 整个卡片容器 -->
        <Border Style="{StaticResource MainCardStyle}" Width="Auto" Height="Auto" MaxWidth="1400">
            <Grid>
                <!-- 卡片内容 -->
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- 卡片标题 -->
                    <TextBlock Grid.Row="0" Text="月度数据分析" Style="{StaticResource PageTitleText}" 
                               TextAlignment="Center" Margin="0,10,0,5"/>

                    <TextBlock Grid.Row="1" Text="故障数量与预约完成情况统计" Style="{StaticResource PageSubtitleText}" 
                               TextAlignment="Center" Margin="0,0,0,30"/>

                    <!-- 柱状图区域 -->
                    <ScrollViewer Grid.Row="2" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Hidden"
                                  Padding="20,0,20,0">
                        <ItemsControl ItemsSource="{Binding MonthlyData}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>

                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <!-- 单个月度柱状图容器 - 应用翻转效果 -->
                                    <Border Style="{StaticResource MonthlyChartContainerStyle}" Margin="12,15,12,15">
                                        <Border.InputBindings>
                                            <!-- 绑定到当前数据项的翻转命令 -->
                                            <MouseBinding MouseAction="LeftClick"
                                                          Command="{Binding DataContext.FlipCardCommand, RelativeSource={RelativeSource AncestorType=Page}}"
                                                          CommandParameter="{Binding}" />
                                        </Border.InputBindings>

                                        <!-- 翻转容器 - 设置固定宽度保证翻转后不变形 -->
                                        <Grid Style="{StaticResource FlipContainerStyle}" Width="160">
                                            <!-- 正面内容 -->
                                            <Grid Visibility="{Binding IsContentFlipped, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=Invert}">
                                                <StackPanel Margin="10">
                                                    <Grid Width="140">
                                                        <Grid.RowDefinitions>
                                                            <RowDefinition Height="Auto"/>
                                                            <RowDefinition Height="200"/>
                                                            <RowDefinition Height="Auto"/>
                                                            <RowDefinition Height="Auto"/>
                                                        </Grid.RowDefinitions>

                                                        <!-- 月份标题 -->
                                                        <TextBlock Grid.Row="0" Text="{Binding Month}" Style="{StaticResource MonthTitleText}" 
                                                                   TextAlignment="Center" Margin="0,15,0,15"/>

                                                        <!-- 柱状图区域 -->
                                                        <Grid Grid.Row="1" Margin="0,10,0,10">
                                                            <Grid VerticalAlignment="Bottom" HorizontalAlignment="Center" Height="160" Width="50">
                                                                <StackPanel VerticalAlignment="Bottom" Orientation="Vertical">
                                                                    <!-- 故障数据柱子 -->
                                                                    <Border Style="{StaticResource FaultStackedBarStyle}" 
                                                                            Height="{Binding FaultHeight}"
                                                                            ToolTip="{Binding FaultCount, StringFormat=故障数量: {0}}"/>
                                                                    <!-- 预约数据柱子 -->
                                                                    <Border Style="{StaticResource ReservationStackedBarStyle}" 
                                                                            Height="{Binding ReservationHeight}"
                                                                            ToolTip="{Binding ReservationCount, StringFormat=未完成预约: {0}}"/>
                                                                </StackPanel>
                                                            </Grid>
                                                        </Grid>

                                                        <!-- 数值显示区域 -->
                                                        <StackPanel Grid.Row="3" Margin="0,5,0,15" Background="#F8F9FA" 
                                                                    Style="{StaticResource DataDisplayPanelStyle}">
                                                            <TextBlock Style="{StaticResource DataValueText}" FontSize="11" Margin="0,3,0,1">
                                                                <Run Text="故障: " Foreground="#666"/>
                                                                <Run Text="{Binding FaultCount}" Foreground="#4CAF50" FontWeight="Bold"/>
                                                            </TextBlock>
                                                            <TextBlock Style="{StaticResource DataValueText}" FontSize="11" Margin="0,1,0,3">
                                                                <Run Text="预约: " Foreground="#666"/>
                                                                <Run Text="{Binding ReservationCount}" Foreground="#FF9800" FontWeight="Bold"/>
                                                            </TextBlock>
                                                        </StackPanel>
                                                    </Grid>
                                                </StackPanel>
                                            </Grid>

                                            <!-- 背面内容 -->
                                            <Grid Visibility="{Binding IsContentFlipped, Converter={StaticResource BooleanToVisibilityConverter}}" Width="140">
                                                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Margin="10">
                                                    <TextBlock Text="{Binding Month}" Style="{StaticResource MonthTitleText}" 
               TextAlignment="Center" Margin="0,0,0,15"/>
                                                    <TextBlock Text="详细信息" FontSize="14" FontWeight="Bold" 
               TextAlignment="Center" Margin="0,0,0,10"/>
                                                    <StackPanel>
                                                        <TextBlock Text="{Binding FaultCount, StringFormat=故障总数: {0}}" 
                   FontSize="12" Margin="0,2" TextAlignment="Center"/>
                                                        <TextBlock Text="{Binding ReservationCount, StringFormat=未完成预约: {0}}" 
                   FontSize="12" Margin="0,2" TextAlignment="Center"/>
                                                        <TextBlock Text="{Binding CancelledReservationCount, StringFormat=已取消预约: {0}}" 
                   FontSize="12" Margin="0,2" TextAlignment="Center"/>
                                                        <ItemsControl ItemsSource="{Binding FaultEquipments}">
                                                            <ItemsControl.ItemTemplate>
                                                                <DataTemplate>
                                                                    <StackPanel>
                                                                        <TextBlock Text="{Binding Equ_Id, StringFormat=编号: {0}}"
                           FontSize="12" Margin="0,2" TextAlignment="Center"/>
                                                                        <TextBlock Text="{Binding Equ_Name, StringFormat=名称: {0}}"
                           FontSize="12" Margin="0,2" TextAlignment="Center"/>
                                                                    </StackPanel>
                                                                </DataTemplate>
                                                            </ItemsControl.ItemTemplate>
                                                        </ItemsControl>


                                                        <TextBlock Text="点击返回图表" FontSize="10" 
                   Foreground="#666" TextAlignment="Center" Margin="0,10,0,0"/>
                                                    </StackPanel>
                                                </StackPanel>

                                            </Grid>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>

                    <!-- 全局图例说明 -->
                    <Border Grid.Row="3" Style="{StaticResource GlobalLegendContainerStyle}" 
                            Margin="0,20,0,15">
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                            <StackPanel Orientation="Horizontal" Margin="0,0,30,0">
                                <Border Width="16" Height="12" Style="{StaticResource LegendColorBlock}" 
                                        Background="#4CAF50" Margin="0,0,8,0"/>
                                <TextBlock Text="故障数量" Style="{StaticResource GlobalLegendText}"/>
                            </StackPanel>
                            <StackPanel Orientation="Horizontal">
                                <Border Width="16" Height="12" Style="{StaticResource LegendColorBlock}"
                                        Background="#FF9800" Margin="0,0,8,0"/>
                                <TextBlock Text="完成订单" Style="{StaticResource GlobalLegendText}"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                </Grid>
            </Grid>
        </Border>
    </Grid>
</Page>