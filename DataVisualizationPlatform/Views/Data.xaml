<Page x:Class="DataVisualizationPlatform.Views.Data"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:vm="clr-namespace:DataVisualizationPlatform.ViewModels"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      mc:Ignorable="d"
      d:DesignHeight="450" d:DesignWidth="800"
      Style="{StaticResource Page_Style}">

    <Page.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/Resources/Styles/DataStyle.xaml"/>
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </Page.Resources>

    <Page.DataContext>
        <vm:DataViewModel />
    </Page.DataContext>

    <Grid Background="Transparent" Margin="20">
        <!-- 整个卡片容器 -->
        <Border Style="{StaticResource MainCardStyle}" Width="Auto" Height="Auto" MaxWidth="1400">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- 卡片标题 -->
                <TextBlock Grid.Row="0" Text="月度数据分析" Style="{StaticResource PageTitleText}" 
                           TextAlignment="Center" Margin="0,10,0,5"/>

                <TextBlock Grid.Row="1" Text="故障数量与预约完成情况趋势" Style="{StaticResource PageSubtitleText}" 
                           TextAlignment="Center" Margin="0,0,0,30"/>

                <!-- 折线图区域 -->
                <Border Grid.Row="2" Style="{StaticResource LineChartContainerStyle}" Margin="20">
                    <Grid Name="ChartGrid">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="30"/>
                            <!-- Y轴标签区域 -->
                            <RowDefinition Height="*"/>
                            <!-- 图表区域 -->
                            <RowDefinition Height="30"/>
                            <!-- X轴标签区域 -->
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="50"/>
                            <!-- Y轴标签宽度 -->
                            <ColumnDefinition Width="*"/>
                            <!-- 图表宽度 -->
                        </Grid.ColumnDefinitions>

                        <!-- Y轴标签 -->
                        <Grid Grid.Row="1" Grid.Column="0" >
                            <Grid.RowDefinitions>
                                <RowDefinition Height="3*"/>
                                <RowDefinition Height="100"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <TextBlock Grid.Row="0" Text="{Binding MaxReservationCount}" Style="{StaticResource YAxisLabelStyle}" 
                                       VerticalAlignment="Top" Margin="0,0,5,0"/>
                            <TextBlock Grid.Row="1" Text="0" Style="{StaticResource YAxisLabelStyle}" 
                                       VerticalAlignment="Center" Margin="0,0,5,0"/>
                            <TextBlock Grid.Row="2" Text="{Binding MaxFaultCount, StringFormat=-{0}}" Style="{StaticResource YAxisLabelStyle}" 
                                       VerticalAlignment="Bottom" Margin="0,0,5,0"/>
                        </Grid>

                        <!-- 主图表区域 -->
                        <Viewbox Grid.Row="1" Grid.Column="1" Stretch="Fill">
                            <Canvas Name="ChartCanvas" Background="Transparent" 
                                    Width="{Binding ChartWidth}" Height="{Binding ChartHeight}">
                                <!-- 网格线 -->
                                <ItemsControl ItemsSource="{Binding GridLines}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <Canvas/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Line X1="{Binding X1}" Y1="{Binding Y1}" X2="{Binding X2}" Y2="{Binding Y2}"
                                              Style="{StaticResource GridLineStyle}"/>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                    <ItemsControl.ItemContainerStyle>
                                        <Style>
                                            <Setter Property="Canvas.Left" Value="0"/>
                                            <Setter Property="Canvas.Top" Value="0"/>
                                        </Style>
                                    </ItemsControl.ItemContainerStyle>
                                </ItemsControl>

                                <!-- 中轴线 (y=0) -->
                                <Line X1="0" Y1="{Binding CenterLineY}" X2="{Binding ChartWidth}" Y2="{Binding CenterLineY}"
                                  Style="{StaticResource CenterLineStyle}"/>

                                <!-- 预约数据折线 -->
                                <ItemsControl ItemsSource="{Binding ReservationLines}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <Canvas/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Line X1="{Binding X1}" Y1="{Binding Y1}" X2="{Binding X2}" Y2="{Binding Y2}"
                                              Style="{StaticResource ReservationLineStyle}"/>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                    <ItemsControl.ItemContainerStyle>
                                        <Style>
                                            <Setter Property="Canvas.Left" Value="0"/>
                                            <Setter Property="Canvas.Top" Value="0"/>
                                        </Style>
                                    </ItemsControl.ItemContainerStyle>
                                </ItemsControl>

                                <!-- 故障数据折线 -->
                                <ItemsControl ItemsSource="{Binding FaultLines}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <Canvas/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Line X1="{Binding X1}" Y1="{Binding Y1}" X2="{Binding X2}" Y2="{Binding Y2}"
                                              Style="{StaticResource FaultLineStyle}"/>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                    <ItemsControl.ItemContainerStyle>
                                        <Style>
                                            <Setter Property="Canvas.Left" Value="0"/>
                                            <Setter Property="Canvas.Top" Value="0"/>
                                        </Style>
                                    </ItemsControl.ItemContainerStyle>
                                </ItemsControl>

                                
                                <ItemsControl ItemsSource="{Binding ReservationPoints}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <Canvas/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Ellipse Style="{StaticResource ReservationPointStyle}"
                                                 ToolTip="{Binding Value, StringFormat='预约数量: {0}'}"/>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                    <ItemsControl.ItemContainerStyle>
                                        <Style>
                                            <Setter Property="Canvas.Left" Value="{Binding X}"/>
                                            <Setter Property="Canvas.Top" Value="{Binding Y}"/>
                                        </Style>
                                    </ItemsControl.ItemContainerStyle>
                                </ItemsControl>

                                 
                                <ItemsControl ItemsSource="{Binding FaultPoints}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <Canvas/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Ellipse Style="{StaticResource FaultPointStyle}"
                                                 ToolTip="{Binding Value, StringFormat=故障数量: {0}}"/>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                    <ItemsControl.ItemContainerStyle>
                                        <Style>
                                            <Setter Property="Canvas.Left" Value="{Binding X}"/>
                                            <Setter Property="Canvas.Top" Value="{Binding Y}"/>
                                        </Style>
                                    </ItemsControl.ItemContainerStyle>
                                </ItemsControl>
                            </Canvas>
                        </Viewbox>

                        <!-- X轴标签（月份） -->
                        <Viewbox Grid.Row="2" Grid.Column="1" Stretch="Fill">
                            <ItemsControl ItemsSource="{Binding MonthLabels}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <Canvas Width="{Binding ChartWidth}" Height="30"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Month}" Style="{StaticResource MonthLabelStyle}"/>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                                <ItemsControl.ItemContainerStyle>
                                    <Style>
                                        <Setter Property="Canvas.Left" Value="{Binding X}"/>
                                        <Setter Property="Canvas.Top" Value="5"/>
                                    </Style>
                                </ItemsControl.ItemContainerStyle>
                            </ItemsControl>
                        </Viewbox>
                    </Grid>
                </Border>

                <!-- 全局图例说明 -->
                <Border Grid.Row="3" Style="{StaticResource GlobalLegendContainerStyle}" 
                        Margin="0,20,0,15">
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                        <StackPanel Orientation="Horizontal" Margin="0,0,30,0">
                            <Border Width="16" Height="12" Style="{StaticResource LegendColorBlock}" 
                                    Background="#4CAF50" Margin="0,0,8,0"/>
                            <TextBlock Text="预约数量" Style="{StaticResource GlobalLegendText}"/>
                        </StackPanel>
                        <StackPanel Orientation="Horizontal">
                            <Border Width="16" Height="12" Style="{StaticResource LegendColorBlock}"
                                    Background="#FF9800" Margin="0,0,8,0"/>
                            <TextBlock Text="故障数量" Style="{StaticResource GlobalLegendText}"/>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </Grid>
        </Border>
    </Grid>
</Page>