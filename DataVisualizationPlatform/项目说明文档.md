# DataVisualizationPlatform 项目说明文档

## 📋 目录
- [项目概述](#项目概述)
- [技术栈](#技术栈)
- [项目架构](#项目架构)
- [目录结构](#目录结构)
- [快速开始](#快速开始)
- [核心功能](#核心功能)
- [开发规范](#开发规范)
- [配置说明](#配置说明)
- [常见问题](#常见问题)
- [维护指南](#维护指南)

---

## 项目概述

### 项目名称
DataVisualizationPlatform - 数据可视化平台

### 项目描述
这是一个基于WPF的企业级数据可视化平台，主要用于设备管理、预约管理和故障报告的可视化展示。采用MVVM架构模式，结合现代化的UI设计，提供丰富的数据可视化组件。

### 主要功能模块
- 🏠 **主页展示** - 多视图展示（折线图、柱状图、地图）
- 📊 **数据分析** - 按年份/月份展示设备使用统计
- 🔧 **设备信息** - 设备列表管理与查看
- 📝 **预约列表** - 设备预约记录管理
- ⚠️ **故障报告** - 故障记录与统计分析
- 🔐 **用户认证** - 登录系统

### 适用场景
- 设备管理系统
- 实验室预约系统
- 资源调度平台
- 数据监控大屏

---

## 技术栈

### 核心框架
- **.NET 8.0** - 最新的.NET平台
- **WPF (Windows Presentation Foundation)** - Windows桌面应用程序框架
- **C# 12** - 编程语言

### 主要依赖包
```xml
<PackageReference Include="CommunityToolkit.Mvvm" Version="8.4.0" />
<PackageReference Include="Microsoft.Extensions.DependencyInjection" Version="8.0.0" />
<PackageReference Include="MahApps.Metro" Version="2.4.10" />
<PackageReference Include="Newtonsoft.Json" Version="13.0.3" />
<PackageReference Include="GMap.NET.WinPresentation" Version="2.1.7" />
<PackageReference Include="Microsoft.Xaml.Behaviors.Wpf" Version="1.1.77" />
```

### 设计模式
- **MVVM (Model-View-ViewModel)** - 核心架构模式
- **依赖注入 (Dependency Injection)** - 对象管理
- **导航服务 (Navigation Service)** - 页面导航
- **消息传递 (Messenger)** - 组件通信

---

## 项目架构

### 整体架构图
```
┌─────────────────────────────────────────────────────┐
│                   Presentation Layer                │
│                  (Views + XAML)                     │
└─────────────────┬───────────────────────────────────┘
                  │
                  │ Data Binding
                  ↓
┌─────────────────────────────────────────────────────┐
│                  ViewModel Layer                    │
│          (Business Logic + Commands)                │
└─────────────────┬───────────────────────────────────┘
                  │
                  │ Services
                  ↓
┌─────────────────────────────────────────────────────┐
│                   Service Layer                     │
│   (NavigationService, DI Container, Messaging)      │
└─────────────────┬───────────────────────────────────┘
                  │
                  │ Data Access
                  ↓
┌─────────────────────────────────────────────────────┐
│                    Model Layer                      │
│              (Data Models + JSON)                   │
└─────────────────────────────────────────────────────┘
```

### MVVM模式实现

#### View (视图层)
- **职责**: 纯UI展示，不包含业务逻辑
- **文件位置**: `Views/` 文件夹
- **技术**: XAML + 少量CodeBehind

**示例**:
```csharp
public partial class HomePageB : Page
{
    public HomePageB(HomePageBViewModel viewModel)
    {
        InitializeComponent();
        DataContext = viewModel;  // 设置数据上下文
    }
}
```

#### ViewModel (视图模型层)
- **职责**: 业务逻辑、命令处理、数据绑定
- **文件位置**: `ViewModels/` 文件夹
- **基类**: `ViewModelBase` (继承自`ObservableObject`)

**示例**:
```csharp
public partial class MainWindowViewModel : ViewModelBase
{
    private readonly INavigationService _navigationService;

    [ObservableProperty]
    private bool _isButton1Visible;

    [RelayCommand]
    private void Navigate(string? target)
    {
        _navigationService.NavigateTo(target);
    }
}
```

#### Model (模型层)
- **职责**: 数据结构定义
- **文件位置**: `Models/` 文件夹
- **数据源**: JSON文件 (`Services/Json.cs`)

**示例**:
```csharp
public class ReservationListModel
{
    public string Res_Equipment { get; set; }
    public string Res_Date { get; set; }
    public string Res_Status { get; set; }
}
```

---

## 目录结构

```
DataVisualizationPlatform/
│
├── Views/                          # 视图层（XAML页面）
│   ├── Login.xaml                  # 登录页面
│   ├── HomePageA.xaml              # 主页A（折线图）
│   ├── HomePageB.xaml              # 主页B（柱状图）
│   ├── HomePageC.xaml              # 主页C（地图）
│   ├── Data.xaml                   # 数据页面
│   ├── EquipmentInfo.xaml          # 设备信息
│   ├── ReservationList.xaml        # 预约列表
│   ├── FaultReport.xaml            # 故障报告
│   └── Edit.xaml                   # 编辑页面
│
├── ViewModels/                     # 视图模型层
│   ├── ViewModelBase.cs            # ViewModel基类
│   ├── MainWindowViewModel.cs      # 主窗口ViewModel
│   ├── LoginViewModel.cs           # 登录ViewModel
│   ├── HomePageAViewModel.cs       # 主页A ViewModel
│   ├── HomePageBViewModel.cs       # 主页B ViewModel
│   ├── HomePageCViewModel.cs       # 主页C ViewModel
│   ├── DataViewModel.cs            # 数据页面ViewModel
│   ├── EquipmentInfoViewModel.cs   # 设备信息ViewModel
│   ├── ReservationListViewModel.cs # 预约列表ViewModel
│   └── FaultReportViewModel.cs     # 故障报告ViewModel
│
├── Models/                         # 数据模型
│   ├── HomePageModel.cs            # 主页数据模型
│   ├── EquipmentInfoModel.cs       # 设备信息模型
│   ├── ReservationListModel.cs     # 预约列表模型
│   ├── FaultReportModel.cs         # 故障报告模型
│   ├── BarDataItem.cs              # 柱状图数据项
│   ├── LineDataPoint.cs            # 折线图数据点
│   └── EquipmentStatistics.cs      # 设备统计模型
│
├── Services/                       # 服务层
│   ├── Navigation/                 # 导航服务
│   │   ├── INavigationService.cs   # 导航服务接口
│   │   └── NavigationService.cs    # 导航服务实现
│   ├── ExceptionHandling/          # 异常处理
│   │   └── GlobalExceptionHandler.cs
│   └── Json.cs                     # JSON数据服务
│
├── Messages/                       # 消息传递
│   └── ChangePageMessage.cs        # 页面切换消息
│
├── Commands/                       # 命令
│   └── RelayCommand.cs             # 命令实现
│
├── Converters/                     # 值转换器
│   ├── BooleanToVisibilityConverter.cs
│   ├── SubtractConverter.cs
│   └── StatusToBrushConverter.cs
│
├── Behaviors/                      # 行为
│   ├── BlurEffectBehavior.cs       # 模糊效果行为
│   └── PopupDelayCloseBehavior.cs  # Popup延迟关闭
│
├── Controls/                       # 自定义控件
│   ├── SimplePieChart.xaml         # 简单饼图
│   ├── AnimatedLineChart.cs        # 动画折线图
│   ├── ChartDataService.cs         # 图表数据服务
│   └── TianDiTuMapProvider.cs      # 天地图提供者
│
├── Resources/                      # 资源文件
│   ├── Styles/                     # 样式文件
│   │   ├── MainWindowStyle.xaml    # 主窗口样式
│   │   ├── LoginStyle.xaml         # 登录样式
│   │   ├── Button.xaml             # 按钮样式
│   │   ├── Card.xaml               # 卡片样式
│   │   ├── Chart.xaml              # 图表样式
│   │   └── ...                     # 其他样式
│   └── Images/                     # 图片资源
│
├── App.xaml                        # 应用程序入口
├── App.xaml.cs                     # DI容器配置
└── MainWindow.xaml                 # 主窗口
```

---

## 快速开始

### 环境要求
- **操作系统**: Windows 10/11
- **开发工具**: Visual Studio 2022 (17.8+)
- **.NET SDK**: .NET 8.0 SDK
- **可选工具**: Git, Visual Studio Code

### 安装步骤

#### 1. 克隆项目
```bash
git clone <repository-url>
cd DataVisualizationPlatform
```

#### 2. 还原NuGet包
```bash
dotnet restore
```

#### 3. 生成项目
```bash
dotnet build
```

#### 4. 运行项目
```bash
dotnet run
```

或者在Visual Studio中按 `F5` 运行。

### 默认登录凭据
```
用户名: admin
密码:   123456
```

### 首次运行检查清单
- [ ] 确认所有NuGet包已正确还原
- [ ] 检查`Services/Json.cs`中的数据是否正常
- [ ] 验证登录功能
- [ ] 测试各页面导航
- [ ] 检查数据可视化组件是否正常渲染

---

## 核心功能

### 1. 登录系统

**功能描述**: 用户身份验证

**实现位置**:
- View: `Views/Login.xaml`
- ViewModel: `ViewModels/LoginViewModel.cs`

**关键代码**:
```csharp
[RelayCommand(CanExecute = nameof(CanLogin))]
private async Task LoginAsync()
{
    if (Username.Trim() != TEST_USERNAME || Password != TEST_PASSWORD)
    {
        ErrorMessage = "用户名或密码错误";
        return;
    }

    IsBusy = true;
    await Task.Delay(1500); // 模拟加载

    var mainWindow = App.GetService<MainWindow>();
    mainWindow.Show();

    loginWindow?.Close();
}
```

**特点**:
- 输入验证
- 加载动画
- 错误提示
- 异步操作

---

### 2. 导航系统

**功能描述**: 页面间无缝切换

**核心组件**: `NavigationService`

**使用方式**:
```csharp
// 简单导航
_navigationService.NavigateTo("HomePageB");

// 带参数导航
_navigationService.NavigateTo("ReservationList", (month, year));

// 返回上一页
_navigationService.GoBack();
```

**页面注册**: 在`App.xaml.cs`中注册页面和ViewModel
```csharp
services.AddTransient<HomePageB>();
services.AddTransient<HomePageBViewModel>();
```

**导航流程**:
```
用户操作 → Command执行 → NavigationService.NavigateTo()
  ↓
查找页面类型
  ↓
DI容器创建页面实例（自动注入ViewModel）
  ↓
调用INavigationAware.OnNavigatedTo()传递参数
  ↓
页面显示
```

---

### 3. 数据可视化

#### 折线图 (HomePageA)
- **数据源**: 已完成预约按月统计
- **动画**: 3秒缓动动画
- **交互**: 无

#### 柱状图 (HomePageB)
- **数据源**: 故障报告统计
- **动画**: 滚动展示 + 渐变效果
- **交互**: 无

#### 饼图 (HomePageB)
- **数据源**: 设备统计
- **动画**: 旋转动画
- **交互**: 无

#### 地图 (HomePageC)
- **地图供应商**: 天地图
- **功能**: 设备位置标记
- **交互**: 拖拽、缩放

---

### 4. 数据筛选

**Data页面功能**:
- 按年份查看月度数据
- 点击月份卡片查看详细订单
- 动画柱状图展示

**FaultReport页面功能**:
- 按状态筛选
- 按设备筛选
- 按年份/月份筛选
- 重置筛选条件

**实现机制**:
```csharp
public void OnNavigatedTo(object? parameter)
{
    if (parameter != null)
    {
        string targetYear = parameter.ToString();
        InitializeData(targetYear);
    }
}
```

---

### 5. 设备管理

**EquipmentInfo页面**:
- 设备列表展示
- 点击设备查看相关预约

**ReservationList页面**:
- 预约卡片展示
- 翻转动画查看详情
- 按月份/设备筛选

**卡片翻转效果**:
```csharp
private async void FlipCard(ReservationListModel model)
{
    model.IsFlipped = true;
    await Task.Delay(500);
    model.ShowBackContent = true;
}
```

---

## 开发规范

### 命名规范

#### ViewModel命名
- 格式: `{PageName}ViewModel`
- 示例: `HomePageAViewModel`, `LoginViewModel`
- 继承: `ViewModelBase`

#### View命名
- 格式: `{PageName}.xaml`
- 示例: `HomePageA.xaml`, `Login.xaml`
- 类型: `Page` 或 `Window`

#### 属性命名
```csharp
// ObservableProperty字段
[ObservableProperty]
private string _userName;  // 生成: UserName属性

// 命令
[RelayCommand]
private void Login()  // 生成: LoginCommand
```

#### 文件组织
- 一个类一个文件
- 文件名与类名一致
- 使用有意义的命名空间

---

### 代码规范

#### ViewModel规范
```csharp
public partial class ExampleViewModel : ViewModelBase, INavigationAware
{
    // 1. 字段（私有）
    private readonly INavigationService _navigationService;

    // 2. 属性（使用特性生成）
    [ObservableProperty]
    private string _title;

    // 3. 构造函数
    public ExampleViewModel(INavigationService navigationService)
    {
        _navigationService = navigationService;
    }

    // 4. 命令方法
    [RelayCommand]
    private void DoSomething()
    {
        // 实现
    }

    // 5. 私有方法
    private void LoadData()
    {
        // 实现
    }

    // 6. 接口实现
    public void OnNavigatedTo(object? parameter)
    {
        // 实现
    }
}
```

#### XAML规范
```xaml
<!-- 1. 命名空间声明 -->
<Page x:Class="Namespace.ViewName"
      xmlns:local="clr-namespace:Namespace">

    <!-- 2. 资源定义 -->
    <Page.Resources>
        <!-- 样式和转换器 -->
    </Page.Resources>

    <!-- 3. 布局容器 -->
    <Grid>
        <!-- 4. UI元素 -->
        <TextBlock Text="{Binding Title}" />
        <Button Command="{Binding DoSomethingCommand}" />
    </Grid>
</Page>
```

---

### Git提交规范

#### 提交消息格式
```
<type>(<scope>): <subject>

<body>

<footer>
```

#### Type类型
- `feat`: 新功能
- `fix`: 修复bug
- `refactor`: 重构
- `style`: 样式修改
- `docs`: 文档更新
- `test`: 测试相关
- `chore`: 构建/工具相关

#### 示例
```
feat(navigation): 添加导航服务

实现了基于DI的导航服务，支持参数传递和历史记录。

Closes #123
```

---

## 配置说明

### 依赖注入配置

**位置**: `App.xaml.cs` → `ConfigureServices()`

```csharp
private void ConfigureServices(IServiceCollection services)
{
    // 1. 注册服务（单例）
    services.AddSingleton<INavigationService, NavigationService>();

    // 2. 注册ViewModels（瞬态）
    services.AddTransient<MainWindowViewModel>();

    // 3. 注册Views（瞬态）
    services.AddTransient<MainWindow>();
}
```

**服务生命周期**:
- **Singleton**: 全局唯一实例（如NavigationService）
- **Transient**: 每次请求创建新实例（如ViewModel, View）
- **Scoped**: WPF中不常用

---

### 页面注册

**在NavigationService中注册**:
```csharp
private void RegisterPages()
{
    _pageTypes.Add("HomePageA", typeof(Views.HomePageA));
    _pageTypes.Add("HomePageB", typeof(Views.HomePageB));
    // ...
}
```

**在DI容器中注册**:
```csharp
// ViewModel
services.AddTransient<HomePageAViewModel>();

// View
services.AddTransient<HomePageA>();
```

---

## 常见问题

### Q1: 页面导航后没有显示内容？
**原因**: ViewModel未实现`INavigationAware`接口

**解决方案**:
```csharp
public class YourViewModel : ViewModelBase, INavigationAware
{
    public void OnNavigatedTo(object? parameter)
    {
        // 接收参数并加载数据
        LoadData(parameter);
    }

    public void OnNavigatedFrom()
    {
        // 清理资源
    }
}
```

---

### Q2: 图表不显示/不更新？
**原因**: ViewModel的`OnLoaded()`方法未被调用

**解决方案**:
```csharp
// 在View的构造函数中
public HomePageA(HomePageAViewModel viewModel)
{
    InitializeComponent();
    DataContext = viewModel;

    Loaded += (s, e) => viewModel.OnLoaded();
    Unloaded += (s, e) => viewModel.OnUnloaded();
}
```

---

### Q3: 命令绑定无效？
**检查清单**:
1. Command属性名是否正确（方法名+Command）
2. ViewModel是否设置为DataContext
3. 是否使用了`[RelayCommand]`特性
4. CanExecute方法是否返回true

**示例**:
```csharp
// ViewModel
[RelayCommand(CanExecute = nameof(CanSave))]
private void Save() { }
private bool CanSave() => IsValid;

// XAML
<Button Command="{Binding SaveCommand}" />
```

---

### Q4: 数据绑定不生效？
**检查清单**:
1. 属性是否使用`[ObservableProperty]`
2. 是否继承自`ObservableObject`
3. DataContext是否正确设置
4. 绑定路径是否正确

**正确示例**:
```csharp
[ObservableProperty]
private string _name;  // 自动生成Name属性
```

---

### Q5: DI容器获取服务失败？
**原因**: 服务未注册或生命周期不正确

**解决方案**:
```csharp
// 确保在ConfigureServices中注册
services.AddTransient<YourService>();

// 通过构造函数注入
public YourViewModel(YourService service) { }

// 或手动获取
var service = App.GetService<YourService>();
```

---

## 维护指南

### 添加新页面

#### 1. 创建Model（如果需要）
```csharp
// Models/NewPageModel.cs
public class NewPageModel
{
    public string Property1 { get; set; }
    public int Property2 { get; set; }
}
```

#### 2. 创建ViewModel
```csharp
// ViewModels/NewPageViewModel.cs
public partial class NewPageViewModel : ViewModelBase, INavigationAware
{
    [ObservableProperty]
    private string _title = "新页面";

    public void OnNavigatedTo(object? parameter)
    {
        // 初始化逻辑
    }

    public void OnNavigatedFrom()
    {
        // 清理逻辑
    }
}
```

#### 3. 创建View
```xaml
<!-- Views/NewPage.xaml -->
<Page x:Class="DataVisualizationPlatform.Views.NewPage">
    <Grid>
        <TextBlock Text="{Binding Title}" />
    </Grid>
</Page>
```

```csharp
// Views/NewPage.xaml.cs
public partial class NewPage : Page
{
    public NewPage(NewPageViewModel viewModel)
    {
        InitializeComponent();
        DataContext = viewModel;
    }
}
```

#### 4. 注册到DI容器
```csharp
// App.xaml.cs
services.AddTransient<NewPageViewModel>();
services.AddTransient<NewPage>();
```

#### 5. 注册到NavigationService
```csharp
// Services/Navigation/NavigationService.cs
private void RegisterPages()
{
    // ...
    _pageTypes.Add("NewPage", typeof(Views.NewPage));
}
```

#### 6. 导航到新页面
```csharp
_navigationService.NavigateTo("NewPage", parameter);
```

---

### 添加新服务

#### 1. 定义接口
```csharp
public interface INewService
{
    void DoSomething();
}
```

#### 2. 实现服务
```csharp
public class NewService : INewService
{
    public void DoSomething()
    {
        // 实现
    }
}
```

#### 3. 注册服务
```csharp
// App.xaml.cs
services.AddSingleton<INewService, NewService>();
```

#### 4. 使用服务
```csharp
public class SomeViewModel
{
    private readonly INewService _service;

    public SomeViewModel(INewService service)
    {
        _service = service;
    }
}
```

---

### 性能优化建议

#### 1. 虚拟化列表
```xaml
<ListBox VirtualizingPanel.IsVirtualizing="True"
         VirtualizingPanel.VirtualizationMode="Recycling">
    <!-- Items -->
</ListBox>
```

#### 2. 延迟加载
```csharp
public void OnNavigatedTo(object? parameter)
{
    // 先显示页面，再异步加载数据
    await Task.Run(() => LoadData());
}
```

#### 3. 图片优化
```xaml
<Image Source="{Binding ImagePath}"
       DecodePixelWidth="200"
       CacheOption="OnLoad" />
```

#### 4. 避免内存泄漏
```csharp
public override void OnUnloaded()
{
    // 取消事件订阅
    _timer?.Stop();
    WeakReferenceMessenger.Default.Unregister<Message>(this);
}
```

---

### 调试技巧

#### 1. 使用输出窗口
```csharp
System.Diagnostics.Debug.WriteLine($"导航到: {pageName}");
```

#### 2. 绑定调试
```xaml
<!-- 启用绑定失败追踪 -->
<TextBlock Text="{Binding Title,
                  PresentationTraceSources.TraceLevel=High}" />
```

#### 3. 断点调试
- 在ViewModel的关键方法设置断点
- 检查DataContext是否正确
- 验证命令是否执行

#### 4. 使用Snoop工具
- 实时查看可视化树
- 检查属性值
- 调试数据绑定

---

### 版本管理

#### 分支策略
- `main` - 生产环境稳定版本
- `develop` - 开发主分支
- `feature/*` - 功能分支
- `bugfix/*` - 修复分支
- `hotfix/*` - 紧急修复分支

#### 发布流程
1. 从`develop`创建`release/*`分支
2. 测试并修复bug
3. 合并到`main`并打tag
4. 合并回`develop`

---

## 联系方式

### 技术支持
- 项目负责人: [姓名]
- 邮箱: [email@example.com]
- 文档更新日期: 2025-10-29

### 相关资源
- [WPF官方文档](https://docs.microsoft.com/wpf/)
- [MVVM Toolkit文档](https://learn.microsoft.com/windows/communitytoolkit/mvvm/introduction)
- [.NET 8文档](https://learn.microsoft.com/dotnet/)

---

## 附录

### A. 快捷键清单
- `F5` - 启动调试
- `Ctrl+F5` - 运行（不调试）
- `F9` - 设置/取消断点
- `F10` - 单步跳过
- `F11` - 单步进入

### B. 常用命令
```bash
# 清理项目
dotnet clean

# 重新生成
dotnet build

# 运行测试
dotnet test

# 发布
dotnet publish -c Release
```

### C. 推荐扩展
- **Visual Studio**
  - XAML Styler
  - Productivity Power Tools
  - CodeMaid

- **VS Code**
  - C# Dev Kit
  - XAML Complete

---

**文档版本**: v1.0
**最后更新**: 2025-10-29
**适用版本**: DataVisualizationPlatform 1.0.0
